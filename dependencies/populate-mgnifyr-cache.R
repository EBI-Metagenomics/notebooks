# Pre-populate MGnifyR Cache with default examples, to save expensive API calls
library(MGnifyR)
library(KEGGREST)
library(tidyjson)
library(data.table)
library(dplyr)


mg <- mgnify_client(usecache = T, cache_dir = '/home/jovyan/.mgnify_cache')

# For the "Comparative Metagenomics" notebook
tara_all = mgnify_analyses_from_studies(mg, 'MGYS00002008')
metadata = mgnify_get_analyses_metadata(mg, tara_all)

## To generate phyloseq object
clean_acc=c('MGYA00590456','MGYA00590543','MGYA00593110','MGYA00590477','MGYA00593125','MGYA00590448','MGYA00590508','MGYA00589025','MGYA00593139','MGYA00593220','MGYA00590525','MGYA00590534','MGYA00593112','MGYA00590498','MGYA00590535','MGYA00593223','MGYA00590480','MGYA00590496','MGYA00590523','MGYA00590444','MGYA00590517','MGYA00590575','MGYA00589039','MGYA00590574','MGYA00590474','MGYA00590554','MGYA00590469','MGYA00590471','MGYA00590522','MGYA00593141','MGYA00589049','MGYA00593123','MGYA00590564','MGYA00589024','MGYA00590572','MGYA00590545','MGYA00590518','MGYA00593126','MGYA00590526','MGYA00590500','MGYA00590570','MGYA00590520','MGYA00590443','MGYA00589013','MGYA00590449','MGYA00589021','MGYA00593130','MGYA00589047','MGYA00589042','MGYA00590577','MGYA00590470','MGYA00590473','MGYA00593216','MGYA00590562','MGYA00590464','MGYA00590484','MGYA00590462','MGYA00590565','MGYA00590439','MGYA00590472','MGYA00590566','MGYA00590552','MGYA00590485','MGYA00593133','MGYA00590544','MGYA00590455','MGYA00590437','MGYA00589044')
ps = mgnify_get_analyses_phyloseq(mg, clean_acc)

# For the "Fetch Analaysis Metadata for a Study" notebook
analyses_accessions <- mgnify_analyses_from_studies(mg, 'MGYS00005292')
analyses_metadata_df <- mgnify_get_analyses_metadata(mg, head(analyses_accessions, 10))
analyses_ps <- mgnify_get_analyses_phyloseq(mg, analyses_metadata_df$analysis_accession, tax_SU = "SSU")

# For the "Pathways Visualization" notebook
all_accessions = mgnify_analyses_from_studies(mg, c('MGYS00006180','MGYS00006178'))
all_metadata = mgnify_get_analyses_metadata(mg, all_accessions)

collect_pathways <- function(ids_list) {
    pathways = list()
    for (id in ids_list) {
        current_pathway = as.list(keggLink("pathway", id))
        for (index in grep("map", current_pathway)) {
            clean_id = gsub("*path:", "", current_pathway[index])
            prefix = substring(clean_id, 1, 6)
            if(is.na(match("map010", prefix)) & is.na(match("map011", prefix)) & is.na(match("map012", prefix)) ){
                pathways = append(pathways, clean_id)
            }
        }
    }
    return(pathways)
}

modules = c('M00001','M00002','M00003','M00004','M00005','M00006','M00007','M00008','M00009','M00010','M00011','M00015','M00016','M00017','M00018','M00019','M00020','M00021','M00022','M00023','M00024','M00025','M00026','M00028','M00048','M00049','M00050','M00051','M00052','M00053','M00061','M00063','M00064','M00082','M00083','M00086','M00093','M00096','M00115','M00118','M00119','M00120','M00121','M00125','M00126','M00133','M00140','M00144''M00149','M00153','M00157','M00168','M00169','M00307','M00345','M00364','M00417','M00432','M00525','M00530','M00549','M00550','M00554','M00570','M00579','M00580','M00631','M00632','M00745','M00793','M00844','M00846','M00880')
md_pathways = collect_pathways(modules)

samples_list = c('MGYA00642773','MGYA00642774','MGYA00642775','MGYA00642777','MGYA00642779','MGYA00642781','MGYA00642782','MGYA00642783','MGYA00642785','MGYA00642787','MGYA00642792','MGYA00642795','MGYA00642798','MGYA00642801','MGYA00642804','MGYA00642807','MGYA00642811','MGYA00642815','MGYA00642819','MGYA00642822','MGYA00642825','MGYA00642828','MGYA00642832','MGYA00642836','MGYA00642840','MGYA00642846','MGYA00642850','MGYA00642853','MGYA00642857','MGYA00642861','MGYA00642865','MGYA00642870','MGYA00642872','MGYA00642875','MGYA00642879','MGYA00642884','MGYA00642887','MGYA00642890','MGYA00642892','MGYA00643488','MGYA00642677','MGYA00642680','MGYA00642681','MGYA00642684','MGYA00642685','MGYA00642687','MGYA00642688','MGYA00642690','MGYA00642692','MGYA00642693','MGYA00642695','MGYA00642697','MGYA00642698','MGYA00642700','MGYA00642702','MGYA00642703','MGYA00642705','MGYA00642706','MGYA00642707','MGYA00642709','MGYA00642710','MGYA00642711','MGYA00642713','MGYA00642714','MGYA00642716','MGYA00642717','MGYA00642719','MGYA00642721','MGYA00642722','MGYA00642724','MGYA00642726','MGYA00642728','MGYA00642730','MGYA00642732','MGYA00642733','MGYA00642735','MGYA00642737','MGYA00642739','MGYA00642741','MGYA00642743','MGYA00642744','MGYA00642746','MGYA00642747','MGYA00642748','MGYA00642750','MGYA00642751','MGYA00642753','MGYA00642754','MGYA00642755','MGYA00642757','MGYA00642758','MGYA00642759','MGYA00642761','MGYA00642763')
list_of_dfs = list()
for (accession in samples_list) {
    ko_loc = paste0('analyses/',accession,'/kegg-orthologs')
    ko_json = mgnify_retrieve_json(mg, path = ko_loc)
    ko_data = as.data.frame(ko_json %>% spread_all)[ , c("attributes.accession", "attributes.count")]
    colnames(ko_data) = c('ko_id', accession)
    list_of_dfs = append(list_of_dfs, list(ko_data)) 
}

kos_list = c('K00009','K00020','K00033','K00055','K00075','K00099','K00135','K00311','K00335','K00368','K00459','K00528','K00554','K00558','K00571','K00574','K00620','K00641','K00728','K00763','K00768','K00783','K00788','K00789','K00799','K00800','K00820','K00851','K00852','K00859','K00873','K00880','K00891','K00937','K00943','K00951','K00981','K00982','K00990','K01002','K01012','K01057','K01069','K01091','K01092','K01126','K01153','K01154','K01156','K01175','K01185','K01187','K01198','K01201','K01206','K01209','K01223','K01239','K01243','K01246','K01266','K01304','K01356','K01409','K01419','K01421','K01426','K01439','K01442','K01458','K01494','K01496','K01523','K01575','K01591','K01595','K01607','K01609','K01624','K01626','K01644','K01662','K01695','K01712','K01739','K01752','K01754','K01755','K01759','K01775','K01776','K01779','K01783','K01785','K01790','K01803','K01807','K01819','K01854','K01866','K01872','K01875','K01881','K01887','K01890','K01914','K01915','K01919','K01921','K01934','K01939','K01945','K01951','K01972','K01992','K01996','K01997','K01998','K02004','K02025','K02026','K02027','K02028','K02029','K02030','K02036','K02039','K02040','K02042','K02044','K02047','K02081','K02171','K02188','K02204','K02221','K02224','K02227','K02231','K02232','K02233','K02234','K02237','K02238','K02244','K02245','K02246','K02248','K02279','K02283','K02338','K02342','K02434','K02435','K02503','K02600','K02651','K02687','K02759','K02760','K02781','K02793','K02913','K03070','K03071','K03089','K03100','K03101','K03111','K03117','K03177','K03179','K03270','K03282','K03298','K03313','K03315','K03336','K03337','K03394','K03427','K03436','K03438','K03439','K03455','K03466','K03469','K03470','K03478','K03484','K03488','K03496','K03497','K03501','K03524','K03527','K03530','K03544','K03549','K03565','K03589','K03594','K03595','K03601','K03602','K03615','K03621','K03624','K03629','K03630','K03635','K03640','K03643','K03651','K03652','K03664','K03665','K03667','K03675','K03684','K03701','K03702','K03703','K03704','K03718','K03724','K03740','K03742','K03744','K03763','K03789','K03799','K03979','K04063','K04066','K04083','K04092','K04095','K04096','K04485','K04487','K04751','K05346','K05524','K05601','K05832','K05845','K05846','K05847','K05878','K05895','K05896','K05936','K05939','K05989','K06024','K06042','K06076','K06187','K06201','K06217','K06223','K06287','K06442','K06901','K06905','K06909','K06915','K06923','K06925','K06958','K06970','K07001','K07005','K07010','K07012','K07017','K07018','K07040','K07043','K07052','K07056','K07082','K07090','K07114','K07126','K07139','K07149','K07171','K07177','K07223','K07243','K07258','K07267','K07275','K07284','K07304','K07316','K07323','K07334','K07407','K07447','K07452','K07459','K07461','K07473','K07478','K07482','K07485','K07491','K07493','K07495','K07503','K07533','K07566','K07733','K07738','K07979','K08305','K08309','K08311','K08316','K08591','K08659','K08968','K09009','K09384','K09457','K09474','K09705','K09772','K09780','K09787','K09800','K09811','K09922','K09963','K10040','K10112','K10117','K10118','K10708','K10773','K10804','K10822','K11031','K11070','K11753','K12524','K12574','K13252','K13292','K13408','K13409','K15523','K15974','K15977','K16203','K16328','K16785','K16899','K16923','K16925','K17675','K17759','K18199','K18831','K19055','K19156','K19157','K19222','K19267','K19270','K21449','K21471','K21498','K21572','K22522','K22757','K22902')
ko_pathways = collect_pathways(kos_list)

enzymes_list = c('1.1.1.1','1.1.1.100','1.1.1.103','1.1.1.125','1.1.1.127','1.1.1.130','1.1.1.132','1.1.1.133','1.1.1.14','1.1.1.157','1.1.1.159','1.1.1.169','1.1.1.17','1.1.1.18','1.1.1.193','1.1.1.202','1.1.1.205','1.1.1.21','1.1.1.22','1.1.1.23','1.1.1.25','1.1.1.251','1.1.1.255','1.1.1.262','1.1.1.267','1.1.1.27','1.1.1.271','1.1.1.272','1.1.1.274','1.1.1.28','1.1.1.283','1.1.1.284','1.1.1.29','1.1.1.290','1.1.1.3','1.15.1.1','1.16.3.1','1.16.3.2','1.17.1.2','1.17.1.4','1.17.1.8','1.17.4.1','1.17.4.2','1.17.7.3','1.17.98.1','1.17.99.5','1.18.1.2','1.18.6.1','1.2.1.10','1.2.1.11','1.2.1.12','1.2.1.2','1.2.1.38','1.2.1.41','1.2.1.70','1.2.1.79','1.2.3.3','1.2.4.2','1.2.4.4','1.2.5.1','1.2.7.1','1.2.7.3','1.2.7.5','1.2.7.7','1.2.7.8','1.2.99.2','1.2.99.7','1.20.4.1','1.21.4.1','1.21.4.2','1.21.4.3','1.21.4.4','1.3.1.1','1.3.1.12','1.3.1.14','1.3.1.44','1.3.1.54','1.3.1.74','1.3.1.76','1.3.1.9','1.3.1.98','1.3.3.3','1.3.5.1','1.3.5.2','1.3.5.4','1.3.98.1','1.3.99.1','1.3.99.2','1.3.99.22','1.4.1.1','1.4.1.13','1.4.1.14','1.4.1.16','1.4.1.2','1.4.1.21','1.4.3.16','1.4.3.5','2.1.1.168','2.1.1.186','2.1.1.199','2.1.1.206','2.1.1.37','2.1.1.45','2.1.1.51','2.4.2.29','2.4.2.3','2.4.2.4','2.4.2.43','2.5.1.15','2.5.1.16','2.5.1.17','2.5.1.19','2.5.1.29','2.5.1.3','2.5.1.31','2.5.1.47','2.5.1.48','2.5.1.49','2.5.1.54','2.5.1.55','2.5.1.56','2.5.1.6','2.5.1.61','2.5.1.7','2.5.1.72','2.5.1.74','2.5.1.75','2.5.1.78','2.5.1.9','2.5.1.96','2.7.1.100','2.7.1.107','2.7.1.11','2.7.1.12','2.7.1.121','2.7.1.130','2.7.1.15','2.7.1.156','2.7.1.16','2.7.1.89','2.7.1.90','2.7.1.92','2.7.1.95','2.7.10.2','2.7.11.1','2.7.11.32','2.7.11.5','2.7.13.3','2.7.2.1','2.7.2.11','2.7.2.2','2.7.2.3','2.7.2.4','2.7.2.7','2.7.2.8','2.7.3.3','2.7.3.9','2.7.4.1','2.7.4.14','2.7.4.16','2.7.4.2','2.7.4.22','2.7.4.23','2.7.4.25','2.7.4.27','2.7.4.3','2.7.4.6','2.7.4.7','2.7.4.8','2.7.4.9','2.7.6.1','2.7.6.2','2.7.6.5','2.7.7.1','2.7.7.12','2.7.7.18','2.7.7.2','2.7.7.21','2.7.7.22','2.7.7.23','2.7.7.24','2.7.7.25','2.7.7.27','2.7.7.3','2.7.7.33','2.7.7.38','2.7.7.39','2.7.7.4','2.7.7.41','2.7.7.42','2.7.7.43','2.7.7.49','2.7.7.56','2.7.7.58','2.7.7.6','2.7.7.60','2.7.7.61','2.7.7.62','2.7.7.63','2.7.7.65','2.7.7.7','2.7.7.72','2.7.7.77','2.7.7.8','3.1.3.33','3.1.3.6','3.1.3.71','3.1.3.73','3.1.3.82','3.1.4.14','3.1.4.46','3.1.4.52','3.1.4.53','3.1.4.57','3.1.5.1','3.1.7.2','3.2.1.135','3.2.1.17','3.2.1.18','3.2.1.20','3.2.1.21','3.2.1.22','3.2.1.23','3.2.1.26','3.2.1.28','3.2.1.31','3.2.1.35','3.2.1.37','3.2.1.4','3.2.1.41','3.2.1.51','3.2.1.52','3.2.1.55','3.2.1.70','3.2.1.74','3.2.1.8','3.2.1.85','3.2.1.86','3.2.1.89','3.2.1.93','3.2.1.99','3.2.1.n1','3.2.1.n2','3.2.2.1','3.2.2.16','3.2.2.19','3.2.2.20','3.2.2.23','3.2.2.27','3.2.2.4','3.2.2.8','3.2.2.9','3.3.1.1','3.4.11.1','3.4.11.18','3.4.11.19','3.4.11.2','3.4.11.4','3.4.11.5','3.4.11.7','3.4.11.9','3.4.13.18','3.4.13.19','3.4.13.22','3.4.13.3','3.4.13.9','3.4.14.11','3.4.16.4','3.4.17.11','3.4.17.19','3.4.17.4','3.4.19.11','3.4.19.3','3.4.21.102','3.4.21.107','3.4.21.53','3.4.21.88','3.4.21.89','3.4.21.92','3.4.22.40','3.4.22.70','3.4.23.36','3.4.23.43','3.4.24.70','3.4.24.78','3.4.25.2','3.5.1.1','3.5.1.10','3.5.1.14','3.5.1.16','3.5.1.18','3.5.1.19','3.5.1.2','3.5.1.24','3.5.1.25','3.5.1.28','3.5.1.3','3.5.1.4','3.5.1.42','3.5.1.44','3.5.1.47','3.5.1.5','3.5.1.53','3.5.1.87','3.5.1.88','3.5.1.94','3.5.2.10','3.5.2.15','3.5.2.2','3.5.2.3','3.5.2.5','3.5.2.6','3.5.2.7','3.5.3.1','3.5.3.11','3.5.3.12','3.5.3.18','3.5.3.26','3.5.3.6','3.5.3.8','3.5.3.9','3.5.4.1','3.5.4.10','3.5.4.12','3.5.4.13','3.5.4.16','3.5.4.19','3.5.4.2','3.5.4.25','3.5.4.26','3.5.4.28','3.5.4.5','3.5.4.9','3.5.99.3','3.5.99.6','3.6.1.1','3.6.1.11','3.6.1.13','3.6.1.54','3.6.1.7','3.6.3.12','3.6.3.14','3.6.3.15','3.6.3.17','3.6.3.19','3.6.3.2','3.6.3.21','3.6.3.24','3.6.3.25','3.6.3.27','3.6.3.28','3.6.3.29','3.6.3.3','3.6.3.30','3.6.3.31','3.6.3.33','3.6.3.34','3.6.3.4','3.6.3.5','3.6.3.54','3.6.3.8','3.6.4.12','3.6.4.13','3.6.5.3','3.6.5.n1','3.7.1.14','3.8.1.2','4.1.1.11','4.1.1.15','4.1.1.18','4.1.1.19','4.1.1.20','4.1.1.22','4.1.1.23','4.3.3.7','4.3.99.3','4.4.1.15','4.4.1.21','4.4.1.5','4.4.1.8','4.6.1.12','4.99.1.1','4.99.1.3','4.99.1.4','5.1.1.1','5.1.1.13','5.1.1.3','5.1.1.4','5.1.1.7','5.1.3.1','5.1.3.11')
kos_presence = list()
for( ec_number in enzymes_list ){ 
    current_kos = as.list(names(as.list(keggFind("ko", ec_number))))
    kos_presence = append(kos_presence, current_kos) 
}

cpd_names = c('C05627','C00642','C01479','C08261','C08277','C01657','C06424','C02678','C08362','C00249','C11002','C06427','C01595','C00712','C01530','C19615','C06428','C00219','C03242','C16526','C14829','C06429','C09069','C16513','C16527','C16512','C08316','C16512','C03242','C08323','C00219','C16513','C17658','C04483','C16513','C04643','C17647','C00695','C02528','C15557','C02528','C00219','C05464','C00695','C00695','C17148','C02528','C16513','C16939','C02592','C05465','C05463','C17148','C00219','C16939','C00219','C05794','C00319','C03882','C00319','C16512','C00319','C00187','C00599','C01753','C00599','C00599','C00599','C00319','C00599','C00599','C00163','C00041','C00209','C00186','C02356','C00383','C05984','C00716','C00258','C15571','C00106','C00148','C00141','C01585','C00183','C00042','C00188','C00633','C00253','C06730','C00245','C00178','C01073','C00123','C00152','C00049','C00149','C00147','C00262','C07086','C07588','C00870','C06423','C00026','C00064','C00025','C02630','C00073','C00898','C00181','C05629','C00242','C00385','C00474','C00135','C00295','C05132','C02781','C00079','C05607','C00366','C00493','C08278','C00062','C00327','C00072','C00082','C05582','C00794','C12283','C00847','C08261','C00624','C00158','C00191','C08277','C00078','C16361','C00864','C00491','C16537','C00299','C02067','C05512','C00294','C06428','C01970','C00255','C17658','C00695','C01921','C00134','C00041','C00099','C00114','C00716','C00380','C00388','C00791','C02714','C00148','C00183','C00719','C00188','C00253','C00245','C01879','C00408','C02714','C01015','C00300','C00123','C00407','C00152','C00077','C00262','C02918','C01004','C02735','C00785','C20522','C10172','C01035','C01181','C01996','C00064','C00047','C00025','C00073','C06771','C00534','C00318','C02989','C04152','C02242','C00079','C16357','C00534','C01152','C00062','C05545','C00327','C00082','C00612','C03793','C01717','C00624','C07481','C02997','C16366','C03626','C00078','C00624','C00864','C01262','C00559','C05512','C00378','C00294','C03882','C03413','C00836','C12144','C00486','C05793')
cpd_pathways = collect_pathways(cpd_names)

